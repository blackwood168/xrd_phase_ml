name: Monitor Changes, Lint, and Send Notifications

on:
  push:
    branches: [ auto_commit ]  # Adjust this to the branch you want to monitor
  workflow_dispatch:

jobs:
  lint_and_notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install flake8
      run: |
        python -m pip install --upgrade pip
        pip install flake8

    - name: Run flake8
      id: flake8
      run: |
        flake8 scripts/auto_commit.py pl_models.py test.py train.py \
              models/unet_fft.py models/xrd_transformer.py models/model.py \
              datasets/train.py datasets/test.py > flake8_output.txt || true

    - name: Get commit details
      id: commit
      run: |
        echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
        echo "files_changed=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})" >> $GITHUB_OUTPUT

    - name: Send Telegram Notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üîÑ –ù–æ–≤—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω!
          
          –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${{ steps.commit.outputs.message }}
          –ê–≤—Ç–æ—Ä: ${{ steps.commit.outputs.author }}
          
          –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
          ${{ steps.commit.outputs.files_changed }}
          
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          
          ‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–∏–Ω—Ç–∏–Ω–≥–∞:
          ${{ steps.flake8.outputs.lint_results }}